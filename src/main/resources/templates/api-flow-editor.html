<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Flow 편집기</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
<div class="header">
    <div class="container">
        <h1><i class="fas fa-project-diagram"></i> API Flow 편집기</h1>
        <div class="breadcrumb">
            <a href="project-list.html">프로젝트 관리</a> > API Flow 편집
        </div>
    </div>
</div>

<div class="container">
    <form id="apiFlowForm">
        <!-- 기본 정보 -->
        <div class="card mb-4">
            <div class="card-header">
                <h2><i class="fas fa-info-circle"></i> 기본 정보</h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">제목</label>
                        <input type="text" class="form-control" id="title" placeholder="예: 주문 처리 플로우" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">설명</label>
                        <input type="text" class="form-control" id="description" placeholder="플로우 설명을 입력하세요">
                    </div>
                </div>
            </div>
        </div>

        <!-- 플로우 단계 -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-sitemap"></i> 플로우 단계</h2>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addStep()">
                        <i class="fas fa-plus"></i> 단계 추가
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="stepsList">
                    <div class="empty-state">
                        <i class="fas fa-sitemap"></i>
                        <p>플로우 단계를 추가해 주세요.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 저장 버튼 -->
        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-secondary" onclick="history.back()">취소</button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> 저장
            </button>
        </div>
    </form>
</div>

<style>
    .step-card {
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        margin-bottom: 16px;
        background: var(--white);
    }

    .step-header {
        padding: 12px 16px;
        background: var(--background-gray);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .step-summary {
        font-weight: 500;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .step-number {
        background: var(--primary-color);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
    }

    .step-body {
        padding: 16px;
    }

    .step-type {
        display: inline-block;
        padding: 2px 8px;
        font-size: 11px;
        font-weight: 600;
        border-radius: 3px;
        margin-right: 8px;
    }

    .step-start { background: #10b981; color: white; }
    .step-process { background: #3b82f6; color: white; }
    .step-decision { background: #f59e0b; color: white; }
    .step-end { background: #ef4444; color: white; }

    .flow-arrow {
        text-align: center;
        padding: 8px 0;
        color: var(--text-muted);
        font-size: 18px;
    }
</style>

<script>
    let steps = [];
    let stepCounter = 0;

    function addStep() {
        const step = {
            id: ++stepCounter,
            type: 'process',
            title: '',
            description: '',
            conditions: [],
            nextSteps: []
        };
        steps.push(step);
        renderSteps();
    }

    function removeStep(id) {
        if (confirm('이 단계를 삭제하시겠습니까?')) {
            steps = steps.filter(step => step.id !== id);
            renderSteps();
        }
    }

    function updateStepField(stepId, field, value) {
        const step = steps.find(s => s.id === stepId);
        if (step) {
            step[field] = value;
            renderSteps();
        }
    }

    function moveStep(stepId, direction) {
        const index = steps.findIndex(s => s.id === stepId);
        if (index === -1) return;

        if (direction === 'up' && index > 0) {
            [steps[index], steps[index - 1]] = [steps[index - 1], steps[index]];
        } else if (direction === 'down' && index < steps.length - 1) {
            [steps[index], steps[index + 1]] = [steps[index + 1], steps[index]];
        }
        renderSteps();
    }

    function getStepTypeLabel(type) {
        switch(type) {
            case 'start': return '시작';
            case 'process': return '처리';
            case 'decision': return '판단';
            case 'end': return '종료';
            default: return '처리';
        }
    }

    function renderSteps() {
        const container = document.getElementById('stepsList');

        if (steps.length === 0) {
            container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sitemap"></i>
                        <p>플로우 단계를 추가해 주세요.</p>
                    </div>
                `;
            return;
        }

        container.innerHTML = steps.map((step, index) => `
                <div class="step-card">
                    <div class="step-header">
                        <div class="step-summary">
                            <span class="step-number">${index + 1}</span>
                            <span class="step-type step-${step.type}">${getStepTypeLabel(step.type)}</span>
                            ${step.title || '제목 없음'}
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-secondary" onclick="moveStep(${step.id}, 'up')" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="moveStep(${step.id}, 'down')" ${index === steps.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeStep(${step.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="step-body">
                        <div class="grid grid-cols-2 mb-3">
                            <div class="form-group">
                                <label class="form-label">유형</label>
                                <select class="form-control" onchange="updateStepField(${step.id}, 'type', this.value)">
                                    <option value="start" ${step.type === 'start' ? 'selected' : ''}>시작</option>
                                    <option value="process" ${step.type === 'process' ? 'selected' : ''}>처리</option>
                                    <option value="decision" ${step.type === 'decision' ? 'selected' : ''}>판단</option>
                                    <option value="end" ${step.type === 'end' ? 'selected' : ''}>종료</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">제목</label>
                                <input type="text" class="form-control" value="${step.title}"
                                       onchange="updateStepField(${step.id}, 'title', this.value)"
                                       placeholder="단계 제목">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">설명</label>
                            <textarea class="form-control" onchange="updateStepField(${step.id}, 'description', this.value)"
                                      placeholder="단계에 대한 상세 설명">${step.description}</textarea>
                        </div>
                    </div>
                </div>
                ${index < steps.length - 1 ? '<div class="flow-arrow"><i class="fas fa-arrow-down"></i></div>' : ''}
            `).join('');
    }

    function saveFlow() {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;

        if (!title) {
            alert('제목을 입력해 주세요.');
            return;
        }

        if (steps.length === 0) {
            alert('최소 하나의 단계를 추가해 주세요.');
            return;
        }

        const flowSpec = {
            title,
            description,
            steps: steps.map((step, index) => ({
                order: index + 1,
                type: step.type,
                title: step.title,
                description: step.description
            }))
        };

        console.log('API Flow 저장:', flowSpec);

        // 여기서 실제 저장 API 호출
        alert('저장되었습니다.');
        window.location.href = 'project-list.html';
    }

    document.getElementById('apiFlowForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveFlow();
    });

    // 초기 더미 데이터
    if (new URLSearchParams(window.location.search).get('new')) {
        document.getElementById('title').value = '';
        document.getElementById('description').value = '';
    }
</script>
</body>
</html>