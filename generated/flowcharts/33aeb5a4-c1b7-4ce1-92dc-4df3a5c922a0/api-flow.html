<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 플로우(스타일 적용) - API Flow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.4.0/cytoscape-dagre.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            font-weight: 400;
            transition: all 0.3s ease;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
            z-index: 100;
            position: relative;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.01em;
        }

        .header-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .main {
            height: calc(100vh - 81px);
            position: relative;
            background: rgba(255, 255, 255, 0.9);
            margin: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }

        #cy {
            width: 100%;
            height: 100%;
        }

        .controls {
            position: absolute;
            top: 24px;
            left: 24px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            display: flex;
            padding: 4px;
            gap: 2px;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            color: #525252;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            border-radius: 8px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.8);
            color: #1a1a1a;
        }

        .btn.active {
            color: #ffffff;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.9);
            padding: 24px 32px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .loading::before {
            content: '';
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 테마별 스타일 */
        .theme-forest {
            background: #f0f9f0;
            color: #0d4a2d;
        }
        .theme-forest .header { border-bottom: 1px solid #0d4a2d; }
        .theme-forest .header h1 { color: #0d4a2d; }
        .theme-forest .header-icon { background: #0d4a2d; }
        .theme-forest .main { border: 1px solid #0d4a2d; }
        .theme-forest #cy { background: #f0f9f0; }
        .theme-forest .controls { border: 1px solid #0d4a2d; }
        .theme-forest .btn.active { background: #0d4a2d; }
        .theme-forest .loading { color: #0d4a2d; }
        .theme-forest .loading::before { border-top: 2px solid #0d4a2d; }

        /* Dynamic theme styles injected here */
        /**/
    </style>
</head>
<body class="theme-forest">
<div class="header">
    <h1>
        <div class="header-icon">FL</div>
        <span>회원가입 플로우(스타일 적용)</span>
    </h1>
    <div class="header-actions">
        <button class="btn" onclick="fitGraph()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 3h6v6H3V3zm8 0h6v6h-6V3zM3 11h6v6H3v-6zm8 0h6v6h-6v-6z"/>
            </svg>
            전체 보기
        </button>
    </div>
</div>

<div class="main">
    <div id="loading" class="loading">플로우차트 생성 중...</div>
    <div id="cy" style="display: none;"></div>

    <div class="controls">
        <button class="btn active" onclick="changeLayout('dagre')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 3h18v4H3V3zm0 6h18v4H3V9zm0 6h18v4H3v-4z"/>
            </svg>
            다이어그램
        </button>
        <button class="btn" onclick="changeLayout('hierarchy')">계층형</button>
        <button class="btn" onclick="changeLayout('breadthfirst')">방사형</button>
        <button class="btn" onclick="changeLayout('circle')">원형</button>
    </div>
</div>

<script>
    console.log('Loading Cytoscape...');
    if (typeof cytoscape === 'undefined') {
        console.error('Cytoscape is not loaded!');
        document.getElementById('loading').innerHTML = 'Cytoscape 라이브러리를 로드할 수 없습니다.';
        return;
    }

    if (typeof dagre === 'undefined') {
        console.error('Dagre is not loaded!');
        document.getElementById('loading').innerHTML = 'Dagre 라이브러리를 로드할 수 없습니다.';
        return;
    }

    // dagre 확장 등록
    cytoscape.use(cytoscapeDagre);
    console.log('Cytoscape and dagre loaded successfully');

    let cy = null;

    // 서버에서 전달받은 데이터
    const elements = "[{\"data\":{\"nodeClass\":\"primary\",\"id\":\"A\",\"label\":\"Client\",\"type\":\"external\"}},{\"data\":{\"nodeClass\":\"primary\",\"id\":\"B\",\"label\":\"Auth API\",\"type\":\"service\"}},{\"data\":{\"nodeClass\":\"\",\"id\":\"V1\",\"label\":\"Validate Input\",\"type\":\"service\"}},{\"data\":{\"nodeClass\":\"\",\"id\":\"X\",\"label\":\"Check Duplicate Email\",\"type\":\"service\"}},{\"data\":{\"nodeClass\":\"\",\"id\":\"H\",\"label\":\"Hash Password\",\"type\":\"service\"}},{\"data\":{\"nodeClass\":\"\",\"id\":\"U\",\"label\":\"Create User\",\"type\":\"service\"}},{\"data\":{\"nodeClass\":\"accent\",\"id\":\"C\",\"label\":\"Users DB\",\"type\":\"db\"}},{\"data\":{\"styleType\":\"thick\",\"id\":\"A-B\",\"source\":\"A\",\"label\":\"POST \/signup JSON\",\"target\":\"B\"}},{\"data\":{\"styleType\":\"\",\"id\":\"B-V1\",\"source\":\"B\",\"label\":\"PARSE \u0026 SANITIZE\",\"target\":\"V1\"}},{\"data\":{\"styleType\":\"\",\"id\":\"V1-X\",\"source\":\"V1\",\"label\":\"OK\",\"target\":\"X\"}},{\"data\":{\"styleType\":\"dotted\",\"id\":\"X-C\",\"source\":\"X\",\"label\":\"SELECT BY EMAIL\",\"target\":\"C\"}},{\"data\":{\"styleType\":\"dotted\",\"id\":\"C-X\",\"source\":\"C\",\"label\":\"RESULT\",\"target\":\"X\"}},{\"data\":{\"styleType\":\"dotted\",\"id\":\"X-A\",\"source\":\"X\",\"label\":\"EXISTS: 409 CONFLICT\",\"target\":\"A\"}},{\"data\":{\"styleType\":\"\",\"id\":\"X-H\",\"source\":\"X\",\"label\":\"NOT EXISTS\",\"target\":\"H\"}},{\"data\":{\"styleType\":\"\",\"id\":\"H-U\",\"source\":\"H\",\"label\":\"BCRYPT\/SCRYPT\",\"target\":\"U\"}},{\"data\":{\"styleType\":\"\",\"id\":\"U-C\",\"source\":\"U\",\"label\":\"INSERT USER\",\"target\":\"C\"}},{\"data\":{\"styleType\":\"\",\"id\":\"C-B\",\"source\":\"C\",\"label\":\"OK\",\"target\":\"B\"}},{\"data\":{\"styleType\":\"thick\",\"id\":\"B-A\",\"source\":\"B\",\"label\":\"201 CREATED\",\"target\":\"A\"}}]";
    const cytoscapeStyles = "[{\"selector\":\"node\",\"style\":{\"padding\":\"8px\",\"text-wrap\":\"wrap\",\"color\":\"#0d4a2d\",\"shape\":\"roundrectangle\",\"font-weight\":\"500\",\"font-size\":\"12px\",\"border-color\":\"#2d5a2d\",\"text-halign\":\"center\",\"content\":\"data(label)\",\"background-color\":\"#d4f1d4\",\"text-max-width\":\"120px\",\"width\":\"120px\",\"border-width\":2,\"font-family\":\"Inter, sans-serif\",\"text-valign\":\"center\",\"height\":\"60px\"}},{\"selector\":\"node[type=\\\"db\\\"]\",\"style\":{\"background-color\":\"#a8e6a3\",\"shape\":\"barrel\",\"width\":\"100px\",\"height\":\"70px\"}},{\"selector\":\"node[type=\\\"external\\\"]\",\"style\":{\"background-color\":\"#c3f0c3\",\"shape\":\"ellipse\",\"width\":\"130px\",\"height\":\"70px\"}},{\"selector\":\"node[nodeClass=\\\"primary\\\"]\",\"style\":{\"background-color\":\"#4ade80\",\"border-color\":\"#16a34a\",\"border-width\":3}},{\"selector\":\"node[nodeClass=\\\"accent\\\"]\",\"style\":{\"background-color\":\"#86efac\",\"border-color\":\"#22c55e\",\"border-width\":3}},{\"selector\":\"edge\",\"style\":{\"curve-style\":\"bezier\",\"color\":\"#0d4a2d\",\"text-background-color\":\"rgba(255,255,255,0.8)\",\"width\":2,\"font-size\":\"10px\",\"text-background-padding\":\"2px\",\"font-family\":\"Inter, sans-serif\",\"target-arrow-shape\":\"triangle\",\"content\":\"data(label)\",\"line-color\":\"#2d5a2d\",\"target-arrow-color\":\"#2d5a2d\",\"text-background-opacity\":1}},{\"selector\":\"edge[styleType=\\\"thick\\\"]\",\"style\":{\"width\":4,\"line-color\":\"#16a34a\",\"target-arrow-color\":\"#16a34a\"}},{\"selector\":\"edge[styleType=\\\"dotted\\\"]\",\"style\":{\"line-style\":\"dotted\",\"width\":2,\"line-color\":\"#6b7280\",\"target-arrow-color\":\"#6b7280\"}}]";

    console.log('Elements:', elements);
    console.log('Styles:', cytoscapeStyles);

    // DOM 로드 완료 후 초기화
    document.addEventListener('DOMContentLoaded', function() {
        // 약간의 지연 후 초기화 (라이브러리 완전 로드 대기)
        setTimeout(initializeCytoscape, 200);
    });

    function initializeCytoscape() {
        try {
            console.log('Initializing cytoscape...');

            // 데이터 검증
            if (!elements || elements.length === 0) {
                throw new Error('엘리먼트 데이터가 비어있습니다.');
            }

            if (!cytoscapeStyles || cytoscapeStyles.length === 0) {
                throw new Error('스타일 데이터가 비어있습니다.');
            }

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: cytoscapeStyles,
                layout: {
                    name: 'dagre',
                    rankDir: "LR",
                    spacingFactor: 1.5,
                    nodeDimensionsIncludeLabels: true,
                    animate: true,
                    animationDuration: 500
                },
                minZoom: 0.3,
                maxZoom: 3,
                wheelSensitivity: 0.2,
                ready: function() {
                    console.log('Cytoscape initialized successfully');

                    // 로딩 숨기고 그래프 표시
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('cy').style.display = 'block';

                    // 자동으로 전체 보기 적용
                    setTimeout(() => {
                        if (cy) {
                            cy.fit();
                            cy.center();
                        }
                    }, 100);
                }
            });

            // 이벤트 리스너 추가
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                console.log('노드 클릭:', node.data());
            });

            cy.on('tap', 'edge', function(evt) {
                const edge = evt.target;
                console.log('엣지 클릭:', edge.data());
            });

        } catch (error) {
            console.error('Cytoscape 초기화 오류:', error);
            document.getElementById('loading').innerHTML =
                '플로우차트 렌더링 중 오류가 발생했습니다:<br>' + error.message;
        }
    }

    function changeLayout(layoutName) {
        if (!cy) {
            console.warn('Cytoscape instance not available');
            return;
        }

        // 모든 버튼의 active 클래스 제거
        document.querySelectorAll('.controls .btn').forEach(btn => btn.classList.remove('active'));
        // 클릭된 버튼에 active 클래스 추가
        event.target.closest('.btn').classList.add('active');

        const layoutOptions = {
            dagre: {
                name: 'dagre',
                rankDir: "LR",
                spacingFactor: 1.5,
                nodeDimensionsIncludeLabels: true,
                animate: true,
                animationDuration: 500
            },
            hierarchy: {
                name: 'dagre',
                rankDir: 'TB',
                spacingFactor: 2.0,
                animate: true,
                animationDuration: 500
            },
            breadthfirst: {
                name: 'breadthfirst',
                directed: true,
                spacingFactor: 1.75,
                animate: true,
                animationDuration: 500
            },
            circle: {
                name: 'circle',
                spacingFactor: 1.5,
                animate: true,
                animationDuration: 500
            }
        };

        const layout = layoutOptions[layoutName] || layoutOptions.dagre;
        cy.layout(layout).run();

        // 레이아웃 완료 후 전체 보기 적용
        setTimeout(() => {
            if (cy) {
                cy.fit();
                cy.center();
            }
        }, layout.animationDuration + 100);
    }

    function fitGraph() {
        if (cy) {
            cy.animate({
                fit: {
                    eles: cy.elements(),
                    padding: 50
                },
                center: {
                    eles: cy.elements()
                }
            }, {
                duration: 500
            });
        }
    }
</script>
</body>
</html>
